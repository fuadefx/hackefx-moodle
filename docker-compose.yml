version: '3.9'

services:

  # ==========================
  # Traefik Reverse Proxy (SSL)
  # ==========================
  traefik:
    image: traefik:v2.11
    container_name: traefik
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedByDefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      
      # SSL configuration
      - "--certificatesresolvers.myresolver.acme.httpchallenge=true"
      - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.myresolver.acme.email=you@example.com"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
      
    ports:
      - "80:80"
      - "443:443"

    volumes:
      - "./letsencrypt:/letsencrypt"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"

    networks:
      - moodle-net


  # ==========================
  # PostgreSQL
  # ==========================
  postgres:
    image: postgres:15
    container_name: moodle-postgres
    restart: always
    environment:
      POSTGRES_DB: moodledb
      POSTGRES_USER: moodle
      POSTGRES_PASSWORD: moodlepass
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - ./dbdata:/var/lib/postgresql/data
    networks:
      - moodle-net


  # ==========================
  # Moodle with SSL via Traefik
  # ==========================
  moodle:
    image: hackefx:v3
    container_name: moodle-hackefx
    depends_on:
      - postgres
    environment:
      MOODLE_DOCKER_DBTYPE: pgsql
      MOODLE_DOCKER_DBHOST: postgres
      MOODLE_DOCKER_DBNAME: moodledb
      MOODLE_DOCKER_DBUSER: moodle
      MOODLE_DOCKER_DBPASS: moodlepass
      MOODLE_DOCKER_DBPORT: 5432
      MOODLE_DOCKER_WEB_SCHEME: https
      MOODLE_DOCKER_WEB_HOST: hackefx.electrifex.com
      MOODLE_DOCKER_WEB_PORT: 443
    volumes:
      - ./moodledata:/var/www/moodledata
    networks:
      - moodle-net

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.moodle.rule=Host(`your.domain.com`)"
      - "traefik.http.routers.moodle.entrypoints=websecure"
      - "traefik.http.routers.moodle.tls.certresolver=myresolver"
      - "traefik.http.services.moodle.loadbalancer.server.port=80"


  # ==========================
  # Jobe Servers
  # ==========================
  jobe1:
    image: trampgeek/jobeinabox
    container_name: jobe-server1
    restart: always
    networks:
      - moodle-net
    environment:
      - ALLOWED_HOSTS="1"

  jobe2:
    image: trampgeek/jobeinabox
    container_name: jobe-server2
    restart: always
    networks:
      - moodle-net
    environment:
      - ALLOWED_HOSTS="1"


  # ==========================
  # Jobe Load Balancer (HTTP only)
  # ==========================
  jobe-lb:
    image: nginx:latest
    container_name: jobe-loadbalancer
    ports:
      - "4000:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - jobe1
      - jobe2
    networks:
      - moodle-net


networks:
  moodle-net:
